<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tmate.mapper.PaymentMapper">

    <select id="getPaymentList" resultType="com.tmate.domain.PaymentDTO">
        select SID, substr(credit_no,61,4) as credit_no, pay_company, credit_vali, active from payment where m_id = #{m_id}
    </select>

    <select id="getPaymentByCustomer" resultType="com.tmate.domain.PaymentDTO">
        select SID, substr(credit_no,61,4) as credit_no, pay_company, credit_vali from payment where SID = #{customer_uid}
    </select>

    <insert id="insert">
        insert into payment (SID, m_id, pay_pg, pay_rep, pay_company, credit_no, credit_pw, credit_cvc, credit_vali)
        values(to_char(systimestamp,'yyMMddhh24missff')||pa_sec.nextval,#{m_id},'pg','0',#{pay_company},#{credit_no},#{credit_pw},#{credit_cvc},#{credit_vali})
    </insert>

    <insert id="kakaoReady">
        insert into receipt(tid, m_id, d_id, re_time)
        values(#{tid},#{m_id},#{d_id, jdbcType=VARCHAR},#{re_time})
    </insert>

    <select id="kakaoReadyRes" resultType="com.tmate.domain.KakaoDTO">
        select *
        from (
             select *
             from receipt
             order by re_time desc
                 )
        where m_id=#{m_id} and rownum=1
    </select>

    <update id="kakaoApprove">
        update receipt
        set aid=#{aid} and re_amt = #{re_amt}
        where tid = #{tid}
    </update>

    <delete id="delete">
        delete from payment where SID = #{customer_uid}
    </delete>

    <select id="findPayment" resultType="string">
        select SID
        from payment
        where pay_rep = '1' and m_id = #{m_id}
    </select>

    <update id="updateDRep">
        update payment
        set pay_rep = '0'
        where SID = #{customer_uid}
    </update>

    <update id="updateRep">
        update payment
        set pay_rep = '1'
        where SID = #{customer_uid}
    </update>

    <insert id="paymentInsert">
        insert into payment(sid, m_id, pay_pg, pay_company, card_type)
        values (#{sid},#{m_id},#{pay_pg},#{pay_company},#{card_type})
    </insert>
</mapper>